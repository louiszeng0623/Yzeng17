name: Update Football Calendar (Full Auto Version)

on:
  schedule:
    - cron: "0 */6 * * *"   # 每6小时自动更新
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pandas playwright
          playwright install chromium

      - name: Fetch schedules with Playwright
        run: |
          python3 << 'EOF'
          from playwright.sync_api import sync_playwright
          import pandas as pd
          import os

          os.makedirs("data", exist_ok=True)

          teams = [
              ("chengdu", "https://data.zhibo8.cc/html/team.html?match=&team=%E6%88%90%E9%83%BD%E8%93%89%E5%9F%8E"),
              ("inter",   "https://data.zhibo8.cc/html/team.html?match=&team=%E5%9B%BD%E9%99%85%E7%B1%B3%E5%85%B0"),
          ]

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              page = browser.new_page()

              for filename, url in teams:
                  page.goto(url, wait_until="networkidle")
                  page.click("text=赛程")
                  page.wait_for_load_state("networkidle")

                  table = page.query_selector("table.table-lists:not([style*='display: none'])")
                  rows = table.query_selector_all("tbody tr")

                  data = []
                  for row in rows:
                      tds = row.query_selector_all("td")
                      if len(tds) < 7:
                          continue
                      cols = [c.inner_text().strip() for c in tds]
                      # 结构：0 日期时间  1 主队  3 赛事  4 比分  6 客队  （其余是队徽/星期）
                      date_time = cols[0]
                      home      = cols[1]
                      league    = cols[3]
                      score     = cols[4]
                      away      = cols[6]
                      data.append([date_time, league, home, score, away])

                  df = pd.DataFrame(data, columns=["日期时间","赛事","主队","比分","客队"])
                  df.to_csv(f"data/{filename}.csv", index=False, encoding="utf-8-sig")

              browser.close()

          print("✅ CSV 已生成：data/chengdu.csv, data/inter.csv")
          EOF

      - name: Build ICS from CSV and publish to docs/
        run: |
          python3 << 'EOF'
          import csv, os, re, datetime as dt
          from pathlib import Path

          TZ = "Asia/Shanghai"
          now = dt.datetime.now()

          srcs = [
              ("data/chengdu.csv", "成都蓉城赛程"),
              ("data/inter.csv",   "国际米兰赛程"),
          ]

          def guess_year(month: int) -> int:
              # 赛季跨年时的保守策略：若月份比当前月小很多（>6），认为是下一年
              y = now.year
              if month < (now.month - 6):
                  return y + 1
              return y

          def parse_dt(s: str) -> dt.datetime | None:
              # 输入格式形如 "05-02 19:35" 或 "05-02 19:35\n"
              s = s.strip()
              m = re.match(r"^(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$", s)
              if not m:
                  return None
              mm, dd, HH, MM = map(int, m.groups())
              yyyy = guess_year(mm)
              return dt.datetime(yyyy, mm, dd, HH, MM)

          def ics_header():
              return (
                  "BEGIN:VCALENDAR\r\n"
                  "PRODID:-//Louis Zeng//Auto Football Calendar//CN\r\n"
                  "VERSION:2.0\r\n"
                  f"X-WR-TIMEZONE:{TZ}\r\n"
                  f"BEGIN:VTIMEZONE\r\nTZID:{TZ}\r\nEND:VTIMEZONE\r\n"
              )

          def ics_footer():
              return "END:VCALENDAR\r\n"

          def vevent(start_dt: dt.datetime, summary: str, description: str, uid: str) -> str:
              # 以本地时区写入（含 TZID）
              stamp = dt.datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
              dtstart = start_dt.strftime("%Y%m%dT%H%M00")
              return (
                  "BEGIN:VEVENT\r\n"
                  f"UID:{uid}\r\n"
                  f"DTSTAMP:{stamp}\r\n"
                  f"DTSTART;TZID={TZ}:{dtstart}\r\n"
                  f"SUMMARY:{summary}\r\n"
                  f"DESCRIPTION:{description}\r\n"
                  "END:VEVENT\r\n"
              )

          outdir = Path("docs/calendar")
          outdir.mkdir(parents=True, exist_ok=True)

          index_lines = [
              "<!doctype html><meta charset='utf-8'><title>Football Calendars</title>",
              "<h1>订阅链接</h1><ul>"
          ]

          for src, calname in srcs:
              if not os.path.exists(src):
                  print(f"⚠️ 缺少 {src}，跳过")
                  continue

              events = []
              with open(src, newline="", encoding="utf-8") as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      dtstr = (row.get("日期时间") or "").strip()
                      league = (row.get("赛事") or "").strip()
                      home   = (row.get("主队") or "").strip()
                      score  = (row.get("比分") or "").strip()
                      away   = (row.get("客队") or "").strip()

                      start = parse_dt(dtstr)
                      if not start:
                          continue

                      # 文案
                      title = f"{league} | {home} vs {away}"
                      desc  = f"{league}\\n{home} {score} {away}".strip()

                      uid   = f"{start.strftime('%Y%m%d%H%M')}-{home}-{away}@auto-football"
                      events.append(vevent(start, title, desc, uid))

              ics_path = outdir / (Path(src).stem + ".ics")
              with open(ics_path, "w", encoding="utf-8") as f:
                  f.write(ics_header())
                  for e in events:
                      f.write(e)
                  f.write(ics_footer())

              rel = f"/calendar/{ics_path.name}"
              index_lines.append(f"<li><a href='{rel}'>{calname}</a></li>")
              print(f"✅ 生成 {ics_path}")

          index_lines.append("</ul>")
          with open(outdir.parent / "index.html", "w", encoding="utf-8") as f:
              f.write("\n".join(index_lines))

          print("✅ docs/ 已更新（含 index.html + calendar/*.ics）")
          EOF

      - name: Commit and push
        run: |
          git config user.name "Louis Zeng Bot"
          git config user.email "actions@github.com"
          git add data/*.csv docs/index.html docs/calendar/*.ics || true
          git commit -m "Auto: refresh CSV and ICS calendars" || true
          git push
