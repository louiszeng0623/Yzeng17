name: Update Football Calendar (Full Auto Version)

on:
  schedule:
    - cron: "0 */6 * * *"   # 每6小时自动更新
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pandas playwright
          playwright install chromium

      - name: Fetch schedule (Playwright)
        run: |
          python3 << 'EOF'
          from playwright.sync_api import sync_playwright
          import pandas as pd

          teams = [
              ("chengdu", "https://data.zhibo8.cc/html/team.html?match=&team=%E6%88%90%E9%83%BD%E8%93%89%E5%9F%8E"),
              ("inter", "https://data.zhibo8.cc/html/team.html?match=&team=%E5%9B%BD%E9%99%85%E7%B1%B3%E5%85%B0"),
          ]

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              page = browser.new_page()

              for filename, url in teams:
                  page.goto(url, wait_until="networkidle")

                  # 点击“赛程”tab
                  page.click("text=赛程")
                  page.wait_for_load_state("networkidle")

                  # 选中可见的赛程表
                  table = page.query_selector("table.table-lists:not([style*='display: none'])")
                  rows = table.query_selector_all("tbody tr")

                  data = []
                  for row in rows:
                      cols = [c.inner_text().strip() for c in row.query_selector_all("td")]
                      if len(cols) >= 7:
                          date_time = cols[0]
                          home = cols[1]
                          league = cols[3]
                          score = cols[4]
                          away = cols[6]
                          data.append([date_time, league, home, score, away])

                  df = pd.DataFrame(data, columns=["日期时间", "赛事", "主队", "比分", "客队"])
                  df.to_csv(f"data/{filename}.csv", index=False, encoding="utf-8-sig")

              browser.close()

          print("✅ 成功：成都蓉城 & 国际米兰 赛程已更新")
          EOF

      - name: Commit and push
        run: |
          git config user.name "Louis Zeng Bot"
          git config user.email "actions@github.com"
          git add data/*.csv || true
          git commit -m "Auto update schedule" || true
          git push

