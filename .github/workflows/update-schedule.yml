name: Update Football Calendar (Full Auto Version)

on:
  schedule:
    - cron: '0 20 * * *'   # 每天 UTC 20:00（北京时间次日 04:00）
  workflow_dispatch:
  push:
    paths:
      - 'scripts/**'
      - 'data/**'
      - '.github/workflows/update-schedule.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      # 如需自定义 UA，改这里；不想固定可删除这一行，脚本会随机轮换内置 UA
      DQD_USER_AGENT: "dongqiudiApp/7.1.0 (iPhone; iOS 17.5; Scale/3.00)"
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Fetch latest schedules
        run: python scripts/fetch_schedule.py

      - name: Build ICS calendar
        run: python scripts/build_ics.py

      - name: Update README
        run: python scripts/update_readme.py

      - name: Commit and push updates (safe pull)
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@github.com'
          git fetch origin main
          git add data/ calendar.ics README.md
          git commit -m "自动更新赛程与日历 ⏰ $(date '+%Y-%m-%d %H:%M:%S')" || true
          # 关键：先拉取（rebase），避免 non-fast-forward 报错
          git pull --rebase origin main || true
          git push origin HEAD:main
